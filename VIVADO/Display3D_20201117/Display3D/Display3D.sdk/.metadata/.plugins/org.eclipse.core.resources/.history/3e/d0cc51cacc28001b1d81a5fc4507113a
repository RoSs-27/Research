/*
 * Empty C++ Application
 */
#include <xparameters.h>  //--
#include <xuartlite.h>
#include <xgpio.h>
#include <xtmrctr.h>
#include <xintc.h>
#include <xil_printf.h>

class RevHW {
public:
	u8 major;
	u8 minor;
} REV_HW;

XGpio gpio_ledsw;
const u16 gpio_ledsw_devID = XPAR_GPIO_LEDSW_DEVICE_ID;
const unsigned gpio_led_channel = 1;
const unsigned gpio_sw_channel = 2;

XIntc intc;
const u16 intc_devID = XPAR_INTR_DEVICE_ID;

int init();
int capture_HwRev();



int main()
{
	xil_printf("**********************\n");
	xil_printf("* Project 3D Display *\n");
	xil_printf("**********************\n");

	int i = 37;
	init();
	capture_HwRev();
	xil_printf("Hardware revision is %u.%u\n", ::REV_HW.major, ::REV_HW.minor);

	return 0;
}

// GPIO Interrupt Handler
void GpioHandler(void *CallbackRef)
{
    XGpio *GpioPtr = (XGpio *)CallbackRef;
    xil_printf("Gpio Interrupt!\r\n");
    // Clear the Interrupt
    XGpio_InterruptClear(GpioPtr, 1);
}

int init()
{
	int status;

	//*
	// Initialize GPIO module.
	//
	status = XGpio_Initialize(&::gpio_ledsw, ::gpio_ledsw_devID);
	if (status == XST_SUCCESS) {
		xil_printf("GPIO(DevID=%d) initialization completed.\n", ::gpio_ledsw_devID);
	} else {
		xil_printf("GPIO(DevID=%d) initialization failed.\n", ::gpio_ledsw_devID);
		return XST_FAILURE;
	}

	XGpio_DiscreteWrite(&gpio_ledsw, ::gpio_led_channel, 0xFFFF);
	//*
	// Initialize Interrupt module.
	//
	status = XIntc_Initialize(&::intc, ::intc_devID);
	if (status == XST_SUCCESS) {
		xil_printf("Interrupt controller(DevID=%d) initialization completed.\n", ::intc_devID);
	} else {
		xil_printf("Interrupt controller(DevID=%d) initialization failed.\n", ::intc_devID);
		return XST_FAILURE;
	}
	return XST_SUCCESS;
}

int capture_HwRev()
{
	XGpio gpio_revhw;
	const unsigned gpio_channel = 1;
	const u16 gpio_revhw_devID = XPAR_GPIO_REVHW_DEVICE_ID;
	u32 reg = 0;

	int status = XGpio_Initialize(&gpio_revhw, gpio_revhw_devID);
	if (status == XST_SUCCESS) {
		xil_printf("GPIO(DevID=%d) initialization completed.\n", gpio_revhw_devID);
	} else {
		xil_printf("GPIO(DevID=%d) initialization failed.\n", gpio_revhw_devID);
		return XST_FAILURE;
	}
	reg = XGpio_DiscreteRead(&gpio_revhw, gpio_channel);
	::REV_HW.major = (reg >> 8) & 0xFF;
	::REV_HW.minor = (reg & 0xFF);


	//Xintc_Start(&intc, XPAR_INTC_);

	Xil_ExceptionInit(); //-- Initialize interruption at MicroBlaze.

	//--Register intc.
	//Xil_ExceptionRegisterHandler(XIL_EXCEPTION_ID_INT, (Xil_ExceptionHandler)XIntc_InterruptHander, &intc);

	//Xil_ExceptionEnable(); //-- Enable interruption at MicroBlaze.
	microblaze_enable_interrupts();


	while(1) { //--

	}
	return XST_SUCCESS;
}


